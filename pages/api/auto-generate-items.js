import { MongoClient } from 'mongodb';

const mongoUri = process.env.MONGODB_URI || process.env.DATABASE_URL || '';

let client = null;
let clientPromise = null;

function getMongoClient() {
  if (!mongoUri) return null;
  
  if (!clientPromise) {
    try {
      client = new MongoClient(mongoUri, {
        maxPoolSize: 1,
        serverSelectionTimeoutMS: 15000,
        socketTimeoutMS: 45000,
        connectTimeoutMS: 15000,
        retryWrites: true,
        w: 'majority',
      });
      clientPromise = client.connect();
    } catch (err) {
      console.error('[auto-generate-items] Error al crear cliente MongoDB:', err);
      throw err;
    }
  }
  
  return clientPromise;
}

export default async function handler(req, res) {
  const sendJsonResponse = (status, data) => {
    res.status(status).json(data);
  };

  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return sendJsonResponse(405, { error: 'Método no permitido' });
  }

  try {
    const { numPages } = req.body;
    
    if (!numPages || numPages < 1) {
      return sendJsonResponse(400, {
        error: 'Número de páginas inválido',
        hint: 'Proporciona numPages en el body',
      });
    }

    if (!mongoUri) {
      return sendJsonResponse(500, {
        error: 'MongoDB no está configurado',
        hint: 'Configura MONGODB_URI en las variables de entorno',
      });
    }

    const clientPromise = getMongoClient();
    const mongoClient = await clientPromise;
    const db = mongoClient.db();
    
    console.log(`[auto-generate-items] Generando items para ${numPages} páginas...`);
    
    // Generar productos automáticamente
    const productos = [];
    for (let i = 1; i <= numPages; i++) {
      productos.push({
        id: i,
        nombre: `Producto Página ${i}`,
        descripcion: `Producto ubicado en la página ${i} del catálogo`,
        precio: 0,
        imagen: '',
        paginaAsignada: i,
      });
    }
    
    // Generar hotspots automáticamente
    const hotspots = [];
    for (let i = 1; i <= numPages; i++) {
      hotspots.push({
        id: i,
        pagina: i,
        x: 50, // Centro horizontal
        y: 50, // Centro vertical
        productoId: i,
        enabled: true,
      });
    }
    
    // Actualizar en MongoDB
    await db.collection('catalogs').updateOne(
      { isMain: true },
      {
        $set: {
          numPages: numPages,
          productos: productos,
          hotspots: hotspots,
          autoGeneratedAt: new Date(),
        },
        $setOnInsert: { isMain: true }
      },
      { upsert: true }
    );
    
    console.log(`[auto-generate-items] ✓ Generados ${productos.length} productos y ${hotspots.length} hotspots`);
    
    return sendJsonResponse(200, {
      ok: true,
      message: `Se generaron automáticamente ${productos.length} productos y ${hotspots.length} hotspots`,
      numPages: numPages,
      productosGenerados: productos.length,
      hotspotsGenerados: hotspots.length,
    });
    
  } catch (error) {
    console.error('[auto-generate-items] Error crítico:', {
      message: error.message,
      name: error.name,
      stack: error.stack,
    });
    return sendJsonResponse(500, {
      ok: false,
      error: 'Error al generar items automáticamente',
      details: error.message,
    });
  }
}

